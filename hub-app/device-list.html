<link rel="import" href="device-list-item.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-image/core-image.html">
<link rel="import" href="../bower_components/polymer-filters/polymer-filters.html">

<polymer-element name="device-list" attributes="user device loading" fit vertical layout auto>
  <template>

    <link rel="stylesheet" href="device-list.css">

    <core-list name="list" data="{{thngs | orderBy('name') }}" selection="{{device}}" height="72" flex>

      <template>

        <device-list-item>
          <core-image src="{{model.product.photos[0]}}" preload sizing="cover"></core-image>
          <div class="title">{{model.name}}</div>
          <div class="subtitle">{{model.id}}</div>
        </device-list-item>

      </template>

    </core-list>

  </template>
  <script>
    Polymer('device-list', {

      observe: {
        user: 'refresh'
      },

      eventDelegates: {
        refresh: 'refresh'
      },

      refresh: function () {
        if (this.user) {
          var $this = this;

          this.user.thng().read().then(function (thngs) {
            $this.thngs = thngs;

            var productIds = [];
            for (var i = 0; i < thngs.length; i++) {
              if(thngs[i].product && productIds.indexOf(thngs[i].product) === -1){
                productIds.push(thngs[i].product);
              }
            }

            $this.user.product().read({
              params: {
                ids: productIds.join(',')
              }
            }).then(function (products) {
              for (var k = 0; k < thngs.length; k++) {
                for (var j = 0; j < products.length; j++) {
                  if(products[j]){
                    if(thngs[k].product === products[j].id){
                      $this.thngs[k].product = products[j];
                    }
                  }
                }
                if(typeof $this.thngs[k].product === 'string'){
                  $this.thngs[k].product = null;
                }
              }
            });

          });
        }
      }

    });
  </script>
</polymer-element>
